<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.2//EN"
"http://www.oasis-open.org/docbook/xml/4.2/docbookx.dtd">
<article class="whitepaper">
  <title>MMC installation</title>

  <articleinfo>

    <author>
      <firstname>Cédric</firstname>

      <surname>Delfosse</surname>

      <email>cdelfosse@mandriva.com</email>
    </author>

    <affiliation>
      <orgname>Mandriva</orgname>

    </affiliation>

    <copyright>
      <year>2007 Cédric Delfosse - Mandriva</year>
    </copyright>

    <legalnotice>
      <para></para>
    </legalnotice>

    <revhistory>      
      <revision>
        <revnumber>$Revision$</revnumber>
        <date>$Date$</date>
        <authorinitials>$Author$</authorinitials>
      </revision>
    </revhistory>

    <abstract>
      <para>How to install the MMC (Mandriva Management Console) on a Linux distribution</para>
    </abstract>
  </articleinfo>

  <section>
    <title>Introduction</title>

    <para>
      The MMC (Mandriva Management Console) is made of two parts:
    </para>
    <itemizedlist>
      <listitem>
	<para>
	  An agent running on the machine to manage. We call it « MMC agent ».
	  The agent exports to the network several plugins that allow to manage the machine.
	  Of course, there can be multiple agents running on the network.
	  The agent and its plugins are written in Python.
	</para>
      </listitem>
      <listitem>
	<para>
	  A web interface, that talks to the agent(s) using XML-RPC.
	  The interface is written in PHP4, and use the scriptaculous framework to feature an AJAX experience.
	</para>
      </listitem>
    </itemizedlist>

    <para>
      In this document, we will first explain how to install and configure the MMC agent and its plugins, and then how to install the web interface.
    </para>
    <para>
      These installations instructions are generic: this means they should work on most Linux Distribution.
    </para>

  </section>

  <section id="MDS_DEBIAN">

    <title>Debian users are lucky</title>

    <para>
      ... because MMC debian packages are available.
    </para>

    <para>
      For Debian Sarge, add this in your sources.list:
    </para>

    <screen>
      deb ftp://lds.linbox.org/pub/lds/debian sarge main
    </screen>

    <para>
      For Debian Etch:
    </para>

    <screen>
      deb ftp://lds.linbox.org/pub/lds/debian etch main
    </screen>

    <para>
      Here are the Debian packages naming conventions:
      <itemizedlist>
	<listitem>
	  <para>
	    mmc-agent: the MMC agent package
	  </para>
	</listitem>
	<listitem>
	  <para>
	    python-mmc-plugins-tools: helpers for some plugin 
	  </para>
	</listitem>
	<listitem>
	  <para>
	    python-mmc-PLUGIN: MMC agent plugin
	  </para>
	</listitem>
	<listitem>
	  <para>
	    mmc-web-PLUGIN: web interface plugin
	  </para>
	</listitem>
      </itemizedlist>
    </para>

    <note>
      
      <title>Sample configuration files</title>
      
      <para>
	All MMC related sample configuration files are available in the python-mmc-base package, in directory <filename>/usr/share/doc/python-mmc-base/contrib/</filename>.
	You will find there OpenLDAP, SAMBA and Postfix configuration files.
      </para>
      
    </note>
    
  </section>

  <section>
    
    <title>LDAP server configuration</title>

    <para>
      Since version 1.1.2, the MMC supports both OpenLDAP and Fedora Directory Server.
    </para>
    
    <para>
      One LDAP schema called MMC schema is mandatory.
      This schema and others are available in the mmc-agent tarball, in the directory <filename>contrib/ldap/</filename>.
    </para>

    <section>

      <title>OpenLDAP configuration</title>

      <note>
	<title>OpenLDAP example configuration</title>
	<para>
	  You will find an example of OpenLDAP configuration in the directory <filename>contrib/ldap/</filename> of the mmc-agent tarball.
	</para>
      </note>

      <note>
	<title>Already existing directory</title>
	<para>
	  If you already have an OpenLDAP directory, all you need to do is to include the mmc.schema file.
	</para>
      </note>

      <note>
	<title>Debian based distribution</title>
	<para>
	  When installing the slapd package, debconf allows you to configure the root DN of your LDAP directory, set the LDAP manager password and populate the directory.
	</para>
	<para>
	  So you only need to include the mmc.schema in slapd configuration and you are done.
	</para>
      </note>

      <para>
	Get the file <filename>mmc.schema</filename> from the mmc-agent tarball, and copy it to <filename>/etc/openldap/schema/</filename> (or maybe <filename>/etc/ldap/schema/</filename>).
      </para>
      <para>
	Include this schema in the OpenLDAP configuration, in <filename>/etc/ldap/slapd.conf</filename> (or maybe <filename>/etc/openldap/slapd.conf</filename>):
      </para>
      
      <screen>
	include /etc/openldap/schema/mmc.schema
      </screen>

      <para>
	In the OpenLDAP configuration file, we also define the LDAP DN suffix, the LDAP manager (rootdn) and its password (rootpw):
      </para>

      <screen>
	suffix          "dc=mandriva,dc=com"
	rootdn          "cn=admin,dc=mandriva,dc=com"
	rootpw          {SSHA}gqNR92aL44vUg8aoQ9wcZYzvUxMqU6/8
      </screen>
      
      <para>
	The SSHA password is computed using the slappasswd command:
      </para>

      <screen>
	# slappasswd -s LiNBoX
	{SSHA}gqNR92aL44vUg8aoQ9wcZYzvUxMqU6/8
      </screen>

      <para>
	Once the OpenLDAP server is configured, the base LDAP directory architecture must be created. Create a file called <filename>/tmp/ldap-init.ldif</filename> containing:
      </para>
      
      <screen>
	dn: dc=mandriva,dc=com
	objectClass: top
	objectClass: dcObject
	objectClass: organization
	dc: linbox
	o: linbox
	
	dn: cn=admin,dc=mandriva,dc=com
	objectClass: simpleSecurityObject
	objectClass: organizationalRole
	cn: admin
	description: LDAP Administrator
	userPassword: gqNR92aL44vUg8aoQ9wcZYzvUxMqU6/8	
      </screen>

      <para>
	The userPassword field must be filled with the output of the slappasswd command. Now we inject the LDIF file into the directory:
      </para>

      <screen>
	# /etc/init.d/ldap stop
	# slapadd -l /tmp/ldap-init.ldif
	# /etc/init.d/ldap start
      </screen>
      
      <note>
	<title>LDAP suffix</title>
	<para>
	  In this example, the LDAP suffix is dc=mandriva,dc=com. Of course, you can choose another suffix.
	</para>
      </note>

    </section>

    <section>

      <title>Fedora Directory Server configuration</title>
      
      <para>
	This section need to be updated.
      </para>
      <para>
	Install FDS according to the FDS documentation.
      </para>
      <para>
	The LDAP schemas we provide must be converted and then imported into FDS.
      </para>	

    </section>
    
  </section>

  <section>

    <title>MMC agent and plugins installation and configuration</title>
   
    <section>
      
      <title>Pre-requisite for installation</title>

      <para>
	This part is written in Python, and use lots of third party tools.
      </para>

      <para>
	In this table, we give the needed packages for each distribution and each MMC components.
      </para>
      <para>
	If you have informations for other distributions, you're welcome :)
      </para>

      <informaltable>
	<tgroup cols="7" align="left" colsep="1" rowsep="1">
	  <colspec colnum="1" colname="col1" />
	  <colspec colnum="2" colname="col2" />
	  <colspec colnum="3" colname="col3" />
	  <colspec colnum="4" colname="col4" />
	  <colspec colnum="5" colname="col5" />
	  <colspec colnum="6" colname="col6" />
	  <colspec colnum="7" colname="col7" />	  
	  <thead>
	    <row>
	      <entry>Vendor / MMC component</entry>
	      <entry>MMC agent</entry>
	      <entry>Python base plugin</entry>
	      <entry>Python samba plugin</entry>
	      <entry>Python mail plugin</entry>
	      <entry>Python ox plugin</entry>
	      <entry>Python proxy plugin</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry>Mandriva 2006</entry>
	      <entry>python-twisted</entry>
	      <entry>python-ldap pylibacl</entry>
	      <entry>samba</entry>
	      <entry></entry>
	      <entry>python-psycopg</entry>
	      <entry>squid squidguard</entry>
	    </row>	    
	    <row>
	      <entry>CentOS 4.3</entry>
	      <entry>python-twisted</entry>
	      <entry>python-ldap python-libacl</entry>
	      <entry>samba</entry>
	      <entry></entry>
	      <entry>python-psycopg postgresql-python</entry>
	      <entry>squid squidguard</entry>
	    </row>
	  </tbody>
	</tgroup>
      </informaltable>

      <note>
	<title>CentOS DAG repository</title>
	<para>
	  For some package, you will need to add the DAG repository to yum. Create a file named <filename>/etc/yum.repos.d/DAG.repo</filename> containing:
	</para>
	<screen>
	  # DAG Repository for RedHat Enterprise 4 / CentOS 4
	  [dag]
	  name=DAG Repository
	  baseurl = http://apt.sw.be/redhat/el$releasever/en/$basearch/dag
	  gpgkey=http://dag.wieers.com/packages/RPM-GPG-KEY.dag.txt
	  gpgcheck=1
	  enabled=0
	</screen>
      </note>

    </section>

    <section>

      <title>Installation from source tarball</title>

      <para>
	Get the current mmc-agent tarball at this URL: ftp://lds.linbox.org/pub/lds/sources/current/
      </para>
      
      <screen>
	# tar xzf mmc-agent-x.y.z.tar.gz
	# cd mmc-agent-x.y.z
	# make install
      </screen>

      <para>
	The last command starts the installation: the MMC agent and all its plugins are byte-compiled and installed.
      </para>
      <para>
	The default $PREFIX for installation is <filename>/usr/local</filename>. Here are how the files are installed:
      </para>
      <itemizedlist>
	<listitem>
	  <para>
	    <filename>$PREFIX/sbin/mmc-agent</filename>: the MMC agent
	  </para>
	</listitem>
	<listitem>
	  <para>
	    <filename>$PREFIX/lib/mmc/</filename>: helpers for some MMC plugins
	  </para>
	</listitem>
	<listitem>
	  <para>
	    <filename>/etc/mmc/</filename>: all MMC configuration files. There files are sample files you will need to edit.
	  </para>
	</listitem>
	<listitem>
	  <para>
	    <filename>/etc/init.d/mmc-agent</filename>: MMC agent init script
	  </para>
	</listitem>
	<listitem>
	  <para>
	    <filename>$PREFIX/lib/pythonX.Y/site-packages/mmc</filename>: MMC Python libraries and plugins.
	  </para>
	</listitem>
	<listitem>
	  <para>
	    <filename>$PREFIX/lib/pythonX.Y/site-packages/mmc/plugins/</filename>: MMC Python plugins
	  </para>
	</listitem>
      </itemizedlist>

    </section>
    
    <section>

      <title>MMC agent and Python plugins inter-dependencies</title>

      <para>
	When the MMC agent starts, it looks for all the installed plugins, and tries to activate them.
	Each plugin has a self-test function to check if it can be activated or not. For example, if the « base » plugin can't contact the LDAP, it won't be activated. It the SAMBA schema is not available in the LDAP, the « samba » plugin won't start.
      </para>
      <para>	
	The MMC agent always tries to enable the plugin « base » first. The MMC agent won't start if the plugin « base » can't be activated.
      </para>

    </section>

    <section>

      <title>MMC agent configuration</title>

      <para>
	You can find a full description of the MMC agent configuration file <ulink url="http://lds.linbox.org/content/MMC/conf/en/mmc-agent-configuration-file.html">there</ulink>.
      </para>
      <para>
	With the default configuration file we provide (<filename>/etc/mmc/agent/config.ini</filename>), the MMC agent listen locally to incoming XMLRPC over HTTPS connections on port 7080.
      </para>

    </section>
    
    <section>

      <title>MMC « base » plugin configuration</title>

      <para>
 	You can find a full description of the MMC base plugin configuration file <ulink url="http://lds.linbox.org/content/MMC/conf/en/mmc-python-plugin-base-configuration.html">there</ulink>.
      </para>
      <para>
	The main part of the configuration (<filename>/etc/mmc/plugins/base.ini</filename>) is to set the LDAP server to connect to, and the credentials to use to write into the LDAP.
      </para>
      <para>
	The « defaultUserGroup » option must be set to an existing group in the LDAP.
	You will have to create it using the MMC web interface if this group does not exist.
      </para>

    </section>

    <section>

      <title>MMC « SAMBA » plugin configuration</title>

      <para>
	You can find a full description of the MMC SAMBA plugin configuration file <ulink url="http://lds.linbox.org/content/MMC/conf/en/mmc-python-plugin-samba-configuration.html">there</ulink>.
      </para>
      <para>
	You shouldn't need to edit the configuration file (<filename>/etc/mmc/plugins/samba.ini</filename>).
	This plugin won't be activated if your LDAP directory does not include the SAMBA schema, and well-known RIDs. See the section <xref linkend="MDS_SAMBA" />.
      </para>
      <para>
	ACLs must be enabled on your filesystem. The SAMBA plugin needs them to set the ACLs when creating shares, and SAMBA will be able to map NTFS ACLs to the POSIX ACLs.
      </para>
      <para>
	If you use XFS, ACLs are enabled by default. For ext3, you need to enable ACLs in <filename>/etc/fstab</filename>.
      </para>

    </section>
    
    <section>

      <title>MMC « mail » plugin configuration</title>

      <para>
	You can find a full description of the MMC mail plugin configuration file <ulink url="http://lds.linbox.org/content/MMC/conf/en/mmc-python-plugin-mail-configuration.html">there</ulink>.
      </para>
      <para>
	This plugin won't be activated if your LDAP directory does not include a special mail schema. See the section <xref linkend="MDS_MAIL" />.
      </para>

    </section>

    <section>
      
      <title>MMC « network » plugin configuration</title>

      <para>
	You can find a full description of the MMC network plugin configuration file <ulink url="http://lds.linbox.org/content/MMC/conf/en/mmc-python-plugin-network-configuration.html">there</ulink>.
      </para>
      <para>
	This plugin won't be activated if your LDAP directory does not include special schemas. See the section <xref linkend="MDS_NETWORK" />.
      </para>
      
    </section>


    <section>

      <title>Using MMC agent</title>

      <para>
	To start and stop the MMC agent, use the <filename>/etc/init.d/mmc-agent</filename> script:
      </para>
      <screen>
	# /etc/init.d/mmc-agent stop
	# /etc/init.d/mmc-agent start
      </screen>

      <para>
	The MMC agent must be started to use the MMC web interface.
      </para>

      <para>
	When the MMC agent is started, all startup log messages are written to stderr and <filename>/var/log/mmc/mmc-agent.log</filename>.
      </para>

      <para>
	Here is what is written (for example) if there is no error:
      </para>
      
      <screen>
	# /etc/init.d/mmc-agent start
	Starting Mandriva Management Console XML-RPC Agent: mmc-agent starting...
	Plugin base loaded, API version: 4:0:0 build(82)
	Plugin mail loaded, API version: 3:0:1 build(78)
	Plugin samba loaded, API version: 3:0:2 build(78)
	Plugin proxy loaded, API version: 1:0:0 build(78)
	Daemon PID 13943
	done.
      </screen>

      <para>
	If there is an error:
      </para>
      
      <screen>
	# /etc/init.d/mmc-agent start
	Starting Mandriva Management Console XML-RPC Agent: mmc-agent starting...
	Can't bind to LDAP: invalid credentials.
	Plugin base not loaded.
	MMC agent can't run without the base plugin. Exiting.
	failed.
      </screen>

      <para>
	The base plugin can't bind to LDAP, because the credentials we used to connect to the LDAP server are wrong.
	As the base plugin must be activated to use the MMC agent, the MMC agent exits.
      </para>

      <screen>
	# /etc/init.d/mmc-agent start
	Starting Mandriva Management Console XML-RPC Agent: mmc-agent starting...
	Plugin base loaded, API version: 4:0:0 build(82)
	Plugin mail loaded, API version: 3:0:1 build(78)
	Samba schema are not included in LDAP directory
	Plugin samba not loaded.
	Plugin proxy loaded, API version: 1:0:0 build(78)
	Daemon PID 14010
	done.	
      </screen>
      
      <para>
	In this example, the SAMBA schema has not been detected in the LDAP directory, so the SAMBA plugin is not started.
	But this plugin is not mandatory, so the MMC agent doesn't exit.
      </para>

    </section>

    <section>

      <title>How to disable a plugin</title>

      <para>
	In the .ini file corresponding to the plugin, set « disable = 1 » in the main section.
      </para>

    </section>
    
  </section>

  <section>

    <title>MMC web interface installation</title>
   
    <section>

      <title>Prerequisite</title>
      
      <para>
	The MMC web interface is written in PHP4. Basically, you just need to install an Apache2 server with PHP4 (or PHP5) support.
      </para>
      <para>
	The XML-RPC module of PHP is needed too.
      </para>

    </section>

    <section>

      <title>Description of all the MMC web modules</title>

      <para>
	The mmc-web-base package contains:
      </para>
      <itemizedlist>
	<listitem>
	  <para>the base infrastructure used by all the others MMC web modules</para>
	</listitem>
	<listitem>
	  <para>the MMC login page</para>
	</listitem>
	<listitem>
	  <para>the users and groups management pages</para>
	</listitem>
      </itemizedlist>
      
      <para>
	The others MMC web modules available are:
      </para>

      <itemizedlist>
	<listitem>
	  <para>mmc-web-samba: SAMBA users, groups and computers management, shares management</para>
	</listitem>
	<listitem>
	  <para>mmc-web-mail: mail delivery and mail virtual domains management</para>
	</listitem>
	<listitem>
	  <para>mmc-web-proxy: blacklist management for squidGuard</para>
	</listitem>
	<listitem>
	  <para>mmc-web-network: DNS/DHCP management</para>
	</listitem>
      </itemizedlist>
      
      <para>
	All this module depends on the mmc-web-base module. They won't work if the mmc-web-base module is not installed.
      </para>
      
    </section>

    <section>

      <title>MMC web modules and MMC Python plugins inter-dependencies</title>

      <para>
	A MMC web modules won't show in the web interface if the corresponding Python plugin is not loaded by the contacted MMC agent.
      </para>
      <para>
	For example, you installed the SAMBA web module, but the SAMBA Python plugin of the MMC agent the web interface is connected to has not been activated.
	This will be detected and automatically the SAMBA management module of the web interface won't be displayed.
      </para>

    </section>
    
    <section>

      <title>Installation of mmc-web-base from source tarball</title>

      <para>
	Get the current mmc-web-base tarball <ulink url="ftp://lds.linbox.org/pub/lds/sources/current/">there</ulink>.
      </para>

      <screen>
	# tar xvzpf mmc-web-base-x.y.z.tar.gz
	# cd mmc-web-base-x.y.z
	# make install HTTPDUSER=apache
      </screen>

      <para>
	For some distribution (e.g. Debian based distro), you must use HTTPDUSER=www-data.
      </para>

      <para>
	The installation process copies files to:	
      </para>
      <itemizedlist>
	<listitem>
	  <para>
	    <filename>/usr/local/share/mmc/</filename>: all MMC web interface related files (PHP, images, ...)
	  </para>
	</listitem>
	<listitem>
	  <para>
	    <filename>/etc/mmc/mmc.ini</filename>: MMC web configuration file
	  </para>
	</listitem>
      </itemizedlist>

      <para>
	You can find a full documentation of the mmc.ini file <ulink url="http://lds.linbox.org/content/MMC/conf/en/mmc-web-configuration-file.html">there</ulink>.
      </para>

      <para>
	What you need to change in this file is:
      </para>
      
      <itemizedlist>
	<listitem>
	  <para>
	    « login » and « password »: these are the credentials to connect to the MMC agents on your network (the same credentials as in <filename>/etc/mmc/agent/config.ini</filename>)
	  </para>
	</listitem>
	<listitem>
	  <para>
	    « url » option of the [server_x]: the URL to connect to the MMC agent.
	  </para>
	</listitem>
      </itemizedlist>      

      <para>
	To connect to the MMC web interface using an URL like http://IP/mmc, we add an alias to Apache2:
      </para>

      <screen>
	# cp confs/apache/mmc.conf /etc/httpd/conf.d/mmc.conf
      </screen>

      <para>
	Then don't forget to reload the Apache service.
      </para>
      <para>
	Now you should be able to see the MMC login screen at this URL: http://IP/mmc
      </para>

    </section>

    <section>
      
      <title>Administrator login to the MMC web interface</title>
      
      <para>
	You can always login to the MMC web interface using the login « root » with the LDAP administrator password.
      </para>
      <para>
	After you installed the MMC, this is the only user you can use to log in, because the LDAP directory entry is empty.
      </para>

    </section>
    
    <section>

      <title>Installation of additional MMC web modules</title>

      <para>
	The MMC web tarballs are available <ulink url="ftp://lds.linbox.org/pub/lds/sources/current/">there</ulink>.
      </para>

      <para>
	They are all easy to install. For example:
      </para>

      <screen>
	# tar xvzpf mmc-web-samba-x.y.z.tar.gz
	# cd mmc-web-samba-x.y.z
	# make install
      </screen>

      <para>
	There are no configuration files for all the additional modules.
      </para>
      
    </section>

    <section>

      <title>About firewalling</title>

      <para>
	The MMC web interface communicate with the MMC agent using the TCP port 7080 (default configuration).
	Please check that your firewall configuration doesn't block this port.
      </para>

    </section>
    
    <section>
      
      <title>About SE Linux</title>
      
      <para>
	The MMC web interface opens a socket to communicate with the MMC agent using XML-RPC.
      </para>
      <para>
	On SE Linux enabled systems (e.g. Fedora Core 6), by default Apache can't open socket per policy.
      </para>
      <para>
	So you need to fix or disable your SE linux configuration to make it works.
      </para>
      
    </section>

  </section>
  
  <section id="MDS_SAMBA">

    <title>MDS SAMBA configuration</title>

    <para>
      This section explains how to configure SAMBA with a LDAP directory so that it works with the MMC.
    </para>
    <para>
      Basically, you need to do a classic SAMBA/LDAP setup, SAMBA running as a PDC.
    </para>
    <para>
      A slapd.conf for OpenLDAP and a smb.conf for SAMBA are included into the MMC agent tarball: <filename>contrib/ldap/slapd.conf.samba</filename> and <filename>contrib/samba/smb.conf</filename>. Please use these files as templates for your own configuration.
      If you aren't familiar with SAMBA/LDAP installation, read the <ulink url="http://www.idealx.com/downloads/samba3-ldap-howto.pdf">SAMBA LDAP HOWTO</ulink>. SAMBA LDAP setup is not easy.
    </para>

    <section>
      
      <title>LDAP directory configuration</title>
            
      <para>
	You need to import the SAMBA schema into the LDAP directory.
	The schema file is provided into the MMC agent tarball: <filename>contrib/ldap/samba.schema</filename>.
	But you can also use the schema provided by the SAMBA project.
      </para>
      
    </section>

    <section>

      <title>SAMBA configuration</title>

      <para>
	Stop samba before modifying its configuration:
      </para>
      <screen>
	# /etc/init.d/samba stop
	Or according to your distribution:
	# /etc/init.d/smb stop
      </screen>
      <para>
	In <filename>/etc/samba/smb.conf</filename>, you need to modify the « workgroup », « ldap admin dn » and « ldap suffix » to suit your configuration.
      </para>
      <para>
	SAMBA also needs the credentials of the LDAP manager to write into the LDAP:
      </para>
      <screen>
	# smbpasswd -w LiNBoX
	Setting stored password for "cn=admin,dc=mandriva,dc=com" in secrets.tdb	
      </screen>
      <para>
	Now, SAMBA needs to create the SID for your workgroup:
      </para>
      <screen>
	# net getlocalsid LINBOX
	SID for domain LINBOX is: S-1-5-21-128599351-419866736-2079179792	
      </screen>
      <para>
	Use slapcat to check that the SID has really been recorded into the LDAP. You should find an entry like this:
      </para>
      <screen>
	# slapcat | grep sambaDomainName
	dn: sambaDomainName=LINBOX,dc=mandriva,dc=com	
	...
      </screen>
      <para>
	Now you can start SAMBA:
      </para>
      <screen>
	# /etc/init.d/samba start
      </screen>

    </section>

    <section>

      <title>LDAP directory for SAMBA init</title>

      <para>
	The LDAP directory needs to be populated so that SAMBA can use it. We use the <command>smbldap-populate</command> command from smbldap-tools.
      </para>
      <para>
	This command populates the LDAP with the OUs (Organizational Unit), users and groups needed by SAMBA.
      </para>
      <para>
	A RPM package of smbldap-tools is available at: http://download.gna.org/smbldap-tools/packages/smbldap-tools-0.9.3-1.noarch.rpm
      </para>

      <para>
	Now the smbldap-tools conf file need to be edited. Put this in <filename>/etc/opt/IDEALX/smbldap-tools/smbldap_bind.conf</filename>:
      </para>
      
      <screen>
	slaveDN="cn=admin,dc=mandriva,dc=com"
	slavePw="LiNBoX"
	masterDN="cn=admin,dc=mandriva,dc=com"
	masterPw="LiNBoX"
      </screen>

      <para>
	<filename>smbldap_bind.conf</filename> defines how to connect to and write to the LDAP server.
      </para>

      <para>
	Then edit <filename>smbldap.conf</filename> and set those fields:
      </para>
      
      <screen>
	SID="S-1-5-21-128599351-419866736-2079179792"
	sambaDomain="LINBOX"
	ldapTLS="0"
	suffix="dc=mandriva,dc=com
	sambaUnixIdPooldn="sambaDomainName=LINBOX,${suffix}"
	#defaultMaxPasswordAge="45"
	userSmbHome=""
	userProfile=""
	userHomeDrive=""
      </screen>
      
      <para>
	Now the directory can be populated. Type:
      </para>

      <screen>
	# /opt/IDEALX/sbin/smbldap-populate -m 512 -a administrator
      </screen>

      <para>
	A user called « administrator » will be created, and a prompt will ask you to give its password. 
	Thanks to the « -m 512 » option, this user will belong to the « Domain Admins » group.
      </para>
      
    </section>

    <section id="NSS_LDAP">

      <title>NSS LDAP configuration</title>

      <para>
	SAMBA needs that the OS use the LDAP directory to get user and group lists.
      </para>
      <para>
	To do this, <filename>/etc/nsswitch.conf</filename> and <filename>/etc/ldap.conf</filename> (<filename>/etc/libnss-ldap.conf</filename> for Debian based distros) should be configured.
      </para>
      <para>
	Your <filename>/etc/nsswitch.conf</filename> should look like this:
      </para>
      <screen>
	passwd:     files ldap
	shadow:     files ldap
	group:      files ldap
	
	hosts:      files dns
	
	bootparams: files
	ethers:     files
	netmasks:   files
	networks:   files
	protocols:  files
	rpc:        files
	services:   files
	netgroup:   files
	publickey:  files
	automount:  files
	aliases:    files
      </screen>
      <para>
	Your <filename>/etc/ldap.conf</filename>:
      </para>
      <screen>
	host 127.0.0.1
	base dc=mandriva,dc=com
      </screen>
      
    </section>
    
    <section>

      <title>MMC base plugin configuration for SAMBA</title>

      <para>
	By default, you want your new user to belong to the « Domain Users » group.
      </para>
      <para>
	You just need to set the « defaultUserGroup » option to « Domain Users » in <filename>/etc/mmc/plugins/base.ini</filename>.
      </para>

    </section>

    <section>

      <title>User password expiration</title>

      <para>
	By default, the maximum password age of a SAMBA user is 42 days. Then the user will need to change his/her password.	
      </para>
      <para>
	If you don't want password to expire, type:
      </para>
      <screen>
	# pdbedit -P "maximum password age" -C 0
      </screen>
      <para>
	If you want to check your current password expiration policy:
      </para>
      <screen>
	# pdbedit -P "maximum password age"
      </screen>

    </section>

    <section>

      <title>Giving privileges to SAMBA users and groups</title>

      <para>
	If « enable privileges = yes » is set on your <filename>smb.conf</filename>, you can give privileges to SAMBA users and groups.
      </para>
      <para>
	For example, to give to "Domain Admins" users the right to join a machine to the domain:
      </para>
      
      <screen>
	# net -U administrator rpc rights grant 'DOMAIN\Domain Admins' SeMachineAccountPrivilege
	Password:
	Successfully granted rights.
      </screen>

      <para>
	Notice that you must replace « DOMAIN » by your SAMBA domain name in the command line.
      </para>

      <note>
	<title>Users that can give privileges</title>
	<para>
	  Only users that belong to the "Domain Admins" group can use the <command>net rpc rights grant</command> command to assign privileges.
	</para>
      </note>

    </section>
    
  </section>
  
  <section id="MDS_MAIL">

    <title>MDS mail service configuration</title>

    <section>
      
      <title>LDAP directory configuration</title>
            
      <para>
	You need to import our mail schema into the LDAP directory.
	The schema file is provided into the MMC agent tarball: <filename>contrib/ldap/mail.schema</filename>.
      </para>
      <para>
	Once this schema is imported, you will be able to manage mail delivery attributes thanks to the MMC.
      </para>
      
    </section>
   
    <section>

      <title>Postfix/LDAP configuration</title>

      <para>
	Example Postfix configuration files are included into the MMC agent tarball: <filename>contrib/postfix/</filename>.
      </para>
      <para>
	We provide two kinds of configuration:
      </para>
      <itemizedlist>
	<listitem>
	  <para>
	    no-virtual-domain: the mail domain is fixed in the « mydestination » option in main.cf
	  </para>
	</listitem>
	<listitem>
	  <para>
	    with-virtual-domains: mails are delivered to all mail domains created thanks to the MMC
	  </para>
	</listitem>
      </itemizedlist>

    </section>

    <section>
      
      <title>NSS LDAP configuration</title>

      <para>
	NSS LDAP configuration is needed to deliver mails with the right UIDs/GIDs.
      </para>
      <para>
	See <xref linkend="NSS_LDAP"/>.
      </para>
      
    </section>    
    
  </section>

  <section id="MDS_NETWORK">

    <title>MDS network plugin configuration for integrated DNS/DHCP</title>

    <section>

      <title>Introduction</title>

      <para>
	This plugin allows to store in a LDAP directory:
      </para>
      <itemizedlist>
	<listitem>
	  <para>
	    DNS zones declarations and related DNS records as needed for a standard LAN;
	  </para>
	</listitem>
	<listitem>
	  <para>
	    DHCP server configuration with DHCP subnet, dynamic pool and static host declarations.
	  </para>
	</listitem>
      </itemizedlist>
      
      <para>
	The MMC web interface allows to easily manage the DNS and DHCP services.
      </para>

      <para>
	The network plugin relies on patched version of ISC DHCP 3 and ISC BIND 9:
      </para>
      <itemizedlist>
	<listitem>
	  <para>
	    ISC BIND: a patch featuring a LDAP sdb backend must be applied to your BIND installation.
	    With this patch BIND will be able to read DNS zone declarations from a LDAP directory.
	    This patch is available <ulink url="http://www.venaas.no/ldap/bind-sdb/">there</ulink>. 
	    The stable release of this patch (version 1.0) works fine.
	  </para>
	</listitem>
	<listitem>
	  <para>
	    ISC DHCP: the patch <ulink url="http://home.ntelos.net/~masneyb/">on this page</ulink> allows to store 
	    into a LDAP the DHCP service configuration (instead of <filename>/etc/dhcp3/dhcpd.conf</filename>).
	  </para>
	</listitem>
      </itemizedlist>
      
    </section>

    <section>

      <title>Debian packages for patched versions of BIND and DHCP</title>

      <para>
	We provide Debian (Sarge/Etch) packages for LDAP patched versions of BIND and DHCP.
      </para>
      <para>
	Configure your APT repository as in <xref linkend="MDS_DEBIAN" />, and type:
      </para>
      <screen>
	# apt-get update
	# apt-get install dhcp3-server
	# apt-get install dhcp3-server-ldap
	# apt-get install bind9
      </screen>
      
    </section>
    
    <section>

      <title>DNS service configuration (ISC BIND)</title>

      <para>
	When managing the DNS zones, the MMC agent will create files into the BIND configuration directory (located in <filename>/etc/bind/</filename>). These files must be included in the main BIND configuration file so that the corresponding zones are loaded from the LDAP directory.
      </para>
      <para>
	All the DNS zones are defined in the file <filename>named.conf.ldap</filename>. This file must be included in the main BIND configuration file <filename>named.conf</filename>.	Adding this line at the end of BIND <filename>named.conf</filename> should be sufficient:
      </para>
      <screen>
	include "/etc/bind/named.conf.ldap";
      </screen>      

      <para>
	An example of <filename>named.conf</filename> filename for Debian based system is available in the directory <filename>contrib/bind/</filename> of the mmc-agent tarball.
      </para>
      
    </section>
    
    <section>

      <title>DHCP service configuration (ISC DHCP)</title>
      
      <para>
	The DHCP server needs to know how to load its configuration from LDAP.
	Here is a typical <filename>/etc/dhcp3/dhcpd.conf</filename>:
      </para>
      <screen>
	ldap-server "localhost";
	ldap-port 389;
	ldap-username "cn=admin, dc=mandriva, dc=com";
	ldap-password "LiNBoX";
	ldap-base-dn "dc=mandriva, dc=com";
	ldap-method dynamic;
	ldap-debug-file "/var/log/dhcp-ldap-startup.log";
      </screen>

      <para>
	An example of <filename>dhcpd.conf</filename> filename is available in the directory <filename>contrib/dhcpd/</filename> of the mmc-agent tarball.
      </para>
      
    </section>

    <section>

      <title>LDAP Schemas</title>

      <para>
	Two new LDAP schemas must be imported into your LDAP directory: dnszone.schema and dhcp.schema.
      </para>
      <para>
	Both are available in the directory <filename>contrib/ldap</filename> of the mmc-agent tarball.
      </para>
      <para>
	To speed up LDAP search, you can index these attributes: zoneName, relativeDomainName, dhcpHWAddress, dhcpClassData.
      </para>
      <para>
	For OpenLDAP <filename>slapd.conf</filename> configuration file, you will add:	
      </para>
      <screen>
	index zoneName,relativeDomainName eq 
	index dhcpHWAddress,dhcpClassData eq
      </screen>

    </section>    

    <section>

      <title>MMC network plugin initialization</title>

      <para>
	For the DHCP service only, the MMC network plugin needs to create into the LDAP directory two objects:
      </para>
      <itemizedlist>
	<listitem>
	  <para>
	    the container called "DHCP config" (objectClass dhcpService), where all the DHCP service configuration will be stored
	  </para>
	</listitem>
	<listitem>
	  <para>
	    the primary server (objectClass dhcpServer) that links to the DHCP service configuration.
	    The hostname of the machine running the MMC network plugin will be use to name this entry.
	  </para>
	</listitem>
      </itemizedlist>

      <para>
	The first start of the MMC network plugin should look like:
      </para>
      <screen>
	...
	Created OU ou=DHCP,dc=mandriva,dc=com
	Created DHCP config object
	The server 'your_server_hostname' has been set as the primary DHCP server
	Plugin network loaded ...
	...
      </screen>

    </section>

  </section>  

</article>
