<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.2//EN"
"http://www.oasis-open.org/docbook/xml/4.2/docbookx.dtd">
<article class="whitepaper">

  <title>MMC base plugin configuration file</title>

  <articleinfo>
    
    <author>
      <firstname>Cédric</firstname>
      <surname>Delfosse</surname>
      <email>cdelfosse@mandriva.com</email>
    </author>

    <affiliation>
      <orgname>Mandriva</orgname>
    </affiliation>

    <copyright>
      <year>2006-2008 Cédric Delfosse - Mandriva</year>
    </copyright>

    <revhistory>      
      <revision>
        <revnumber>$Revision$</revnumber>
        <date>$Date$</date>
        <authorinitials>$Author$</authorinitials>
      </revision>
    </revhistory>

    <abstract>
      <para>This document explains the content of the MMC base plugin configuration file</para>
    </abstract>

  </articleinfo>

  <section>

    <title>Introduction</title>
    
    <para>
      The « base » plugin is the main plugin of the MMC Python API. It features base operations like LDAP management (users, groups, etc), user authentication and provisioning.
    </para>
    <para>
      The plugin configuration file is <filename>/etc/mmc/plugins/base.ini</filename>.
    </para>
    <para>
      Like all MMC related configuration file, its file format is INI style. The file is made of sections, each one starting with a « [sectionname] » header. In each section options can be defined like this « option = value ».
    </para>
    <para>
      For example:

      <screen>
	[section1]
	option1 = 1
	option2 = 2

	[section2]
	option1 = foo
	option2 = plop
      </screen>

    </para>

  </section>

  <section>

    <title>Configuration file sections</title>

    <para>
      Here are all the base.ini available sections
    </para>
    
    <table>
      <title>
	base.ini available sections
      </title>
      <tgroup cols="3">
	<thead>
	  <row>
	    <entry>Section name</entry>
	    <entry>Description</entry>
	    <entry>Optional</entry>
	  </row>	  
	</thead>
	<tbody>
	  <row>
	    <entry>ldap</entry>
	    <entry>LDAP access definition</entry>
	    <entry>no</entry>
	  </row>
	  <row>
	    <entry>backup-tools</entry>
	    <entry>Backup tools configuration</entry>
	    <entry>no</entry>
	  </row>
	  <row>
	    <entry>hooks</entry>
	    <entry>Hooks for scripts that interacts with the MMC</entry>
	    <entry>yes</entry>
	  </row>
	  <row>
	    <entry>userdefault</entry>
	    <entry>Attributes and Objectclass values that are added or deleted when adding a new user into the LDAP</entry>
	    <entry>yes</entry>
	  </row>
	</tbody>
      </tgroup>
    </table>

  </section>
  
  <section>

    <title>Section « ldap »</title>

    <para>
      This section defines how the main LDAP is accessed, where are located the users organization units, etc.
    </para>

    <table>
      <title>
	Available options for the "ldap" section
      </title>
      <tgroup cols="4">
	<thead>
	  <row>
	    <entry>Option name</entry>
	    <entry>Description</entry>
	    <entry>Optional</entry>
	    <entry>Default value</entry>
	  </row>	  
	</thead>
	<tbody>
	  <row>
	    <entry>host</entry>
	    <entry>IP address or hostname of the LDAP server</entry>
	    <entry>no</entry>
	    <entry></entry>
	  </row>
	  <row>
	    <entry>baseDN</entry>
	    <entry>LDAP base Distinguished Name (DN)</entry>
	    <entry>no</entry>
	    <entry></entry>
	  </row>

	  <row>
	    <entry>rootName</entry>
	    <entry>LDAP administrator DN</entry>
	    <entry>no</entry>
	    <entry></entry>
	  </row>
	  <row>
	    <entry>password</entry>
	    <entry>LDAP administrator password</entry>
	    <entry>no</entry>
	    <entry></entry>
	  </row>

	  <row>
	    <entry>baseUsersDN</entry>
	    <entry>LDAP organisational unit DN where the users are located</entry>
	    <entry>no</entry>
	    <entry></entry>
	  </row>
	  <row>
	    <entry>baseGroupsDN</entry>
	    <entry>LDAP organisational unit DN where the groups are located</entry>
	    <entry>no</entry>
	    <entry></entry>
	  </row>
	  <row>
	    <entry>gpoDN</entry>
	    <entry>LDAP organisational unit DN where the GPO are located</entry>
	    <entry>yes</entry>
	    <entry>ou=System,baseDN </entry>
	  </row>
	  <row>
	    <entry>userHomeAction</entry>
	    <entry>If set to 1, create and delete user directory when creating/deleting one</entry>
	    <entry>no</entry>
	    <entry></entry>
	  </row>
	  <row>
	    <entry>defaultUserGroup</entry>
	    <entry>When creating an user, set this group as the primary user group</entry>
	    <entry>yes</entry>
	    <entry></entry>
	  </row>
	  <row>
	    <entry>skelDir</entry>
	    <entry>Use the specified directory when creating a user home directory</entry>
	    <entry>yes</entry>
	    <entry>/etc/skel</entry>
	  </row>
	  <row>
	    <entry>defaultHomeDir</entry>
	    <entry>Use this directory as a base directory when creating a user without specifying a home directory. If the creater user is called "foo", his/her homeDirectory will be "defaultHomeDir/foo"</entry>
	    <entry>yes</entry>
	    <entry>/home</entry>
	  </row>
	  <row>
	    <entry>authorizedHomeDir</entry>
	    <entry>a list of directory where user home directory can be put</entry>
	    <entry>yes</entry>
	    <entry>defaultHomeDir</entry>
	  </row>
	  <row>
	    <entry>uidStart</entry>
	    <entry>starting uid number for user accounts</entry>
	    <entry>yes</entry>
	    <entry>10000</entry>
	  </row>
	  <row>
	    <entry>gidStart</entry>
	    <entry>starting gid number for groups</entry>
	    <entry>yes</entry>
	    <entry>10000</entry>
	  </row>
	  <row>
	    <entry>logfile</entry>
	    <entry>LDAP log file path</entry>
	    <entry>no</entry>
	    <entry></entry>
	  </row>
	</tbody>
      </tgroup>
    </table>
    
  </section>

  <section>

    <title>Section « backup-tools »</title>

    <para>
      This section defines where are located the backup tools. The backup tools are used when backuping a home directory or a SAMBA share from the MMC.
    </para>
    
    <table>
      <title>
	Available options for the "backup-tools" section
      </title>
      <tgroup cols="4">
	<thead>
	  <row>
	    <entry>Option name</entry>
	    <entry>Description</entry>
	    <entry>Optional</entry>
	    <entry>Default value</entry>
	  </row>	  
	</thead>
	<tbody>
	  <row>
	    <entry>path</entry>
	    <entry>Where are located the executable needed by the backup tools</entry>
	    <entry>no</entry>
	    <entry></entry>
	  </row>
	  <row>
	    <entry>destpath</entry>
	    <entry>Where the backup are located once done</entry>
	    <entry>no</entry>
	    <entry></entry>
	  </row>
	</tbody>
      </tgroup>
    </table>

  </section>  


  <section>
    
    <title>Section « hooks »</title>
    
    <para>
      The hooks system allow you to run external script when doing some operations with the MMC.
    </para>
    <para>
      The script will be run as root user, with as only argument the full LDIF of the LDAP user. For the å adduser » hook, the LDIF file will contains the userPassword attributes in cleartext.
    </para>

    <table>
      <title>
	Available options for the "hooks" section
      </title>
      <tgroup cols="4">
	<thead>
	  <row>
	    <entry>Option name</entry>
	    <entry>Description</entry>
	    <entry>Optional</entry>
	    <entry>Default value</entry>
	  </row>	  
	</thead>
	<tbody>
	  <row>
	    <entry>adduser</entry>
	    <entry>path to the script launched when a user has been added into the LDAP directory</entry>
	    <entry>yes</entry>
	    <entry></entry>
	  </row>
	  <row>
	    <entry>deluser</entry>
	    <entry>path to the script launched when a user is going to be removed from the LDAP directory</entry>
	    <entry>yes</entry>
	    <entry></entry>
	  </row>
	</tbody>
      </tgroup>
    </table>
    
  </section>

  <section>

    <title>Section « userdefault »</title>

    <para>
      This section allows to set default attributes to a user, or remove them, only at user creation.
    </para>
    <para>
      Each option of this section is corresponding to the attribute you want to act on.
    </para>
    <para>
      If you want to remove the « displayName » attribute of each newly added user:
    </para>
    <screen>
      [userdefault]
      displayName = DELETE
    </screen>
    <para>
      Substitution is done on the value of an option if a string between '%' is found. For example, if you want that all new user have a default email address containing their uid:
    </para>
    <screen>
      [userdefault]
      mail = %uid%@mandriva.com
    </screen>
    <para>
      If you want to add a value to a multi-valuated LDAP attribute, do this:
    </para>
    <screen>
      [userdefault]
      objectClass = +corporateUser
    </screen>
    <para>
      Since version 1.1.0, you can add modifiers that interact with the substitution.
      This modifiers are put between square bracket at the beginning os the string to substitute.
    </para>

    <table>
      <title>
	Available modifiers for substitution
      </title>
      <tgroup cols="2">
	<thead>
	  <row>
	    <entry>modifier character</entry>
	    <entry>Description</entry>
	  </row>	  
	</thead>
	<tbody>
	  <row>
	    <entry>/</entry>
	    <entry>Remove diacritics (accents mark) from the substitution string</entry>
	  </row>
	  <row>
	    <entry>_</entry>
	    <entry>Set substitution string to lower case</entry>
	  </row>
	  <row>
	    <entry>|</entry>
	    <entry>Set substitution string to upper case</entry>
	  </row>
	</tbody>
      </tgroup>
    </table>

    <para>
      For example, you want that all new created users have a default mail address made this way: « firstname.lastname@mandriva.com ».
      But your user firstname/lastname have accent marks, that are forbidden for email address. You do it like this:
    </para>

    <screen>
      [userdefault]
      mail = [_/]%givenName%.%sn%@mandriva.com
    </screen>

  </section>
  
  <section>

    <title>User authentication</title>

    <para>
      The default configuration authenticates users using the LDAP directory specified in the [ldap] section.
    </para>
    <para>
      But it is also possible to set up authentication using an external LDAP server.
    </para>

    <section>

      <title>Section « authentication »</title>

      <para>
	This optional section tells the MMC agent authentication manager how to authenticate a user. Each Python plugin can register "authenticator" objects to the authentication manager, that then can be used to authenticate users.
      </para>
      <para>
	The authentication manager tries each authenticator with the supplied login and password until one successfully authenticate the user.
      </para>
      <para>
	Please note that the user won't be able to log in to the MMC web interface if she/he doesn't have an account in the LDAP directory configured in the [ldap] section of the base plugin. The provisioning system will allow you to automatically create this account.
      </para>
      <para>
	The base plugin registers two authenticators:
      </para>
      <itemizedlist>
	<listitem>
	  <para>
	    baseldap: this authenticator uses the LDAP directory configured in the [ldap] section of the base plugin to authenticate the user,
	  </para>
	</listitem>
	<listitem>
	  <para>
	    externalldap: this authenticator uses an external LDAP directory to authenticate the user.
	  </para>
	</listitem>
      </itemizedlist>

      <table>
	<title>
	  Available options for the "authentication" section
	</title>
	<tgroup cols="4">
	  <thead>
	    <row>
	      <entry>Option name</entry>
	      <entry>Description</entry>
	      <entry>Optional</entry>
	      <entry>Default value</entry>
	    </row>	  
	  </thead>
	  <tbody>
	    <row>
	      <entry>method</entry>
	      <entry>space-separated list of authenticators to try to authenticate a user</entry>
	    <entry>yes</entry>
	    <entry>baseldap</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para>
	The default configuration is:
      </para>
      <screen>
	[authentication]
	method = baseldap
      </screen>

    </section>

    <section>
      <title>authentication_baseldap</title>

      <para>
	This section defines some configuration directives for the baseldap authenticator.
      </para>

      <table>
	<title>
	  Available options for the "authentication_baseldap" section
	</title>
	<tgroup cols="4">
	  <thead>
	    <row>
	      <entry>Option name</entry>
	      <entry>Description</entry>
	      <entry>Optional</entry>
	      <entry>Default value</entry>
	    </row>	  
	  </thead>
	  <tbody>
	    <row>
	      <entry>authonly</entry>
	      <entry>space-separated list of login that will be authentified using this authenticator. Others will be skipped.</entry>
	    <entry>yes</entry>
	    <entry></entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para>
	For example, to make the "baseldap" authenticator only authenticate the virtual MMC "root" user:
      </para>
      <screen>
	[authentication_baseldap]
	authonly = root
      </screen>

    </section>

    <section>

      <title>authentication_externalldap</title>

      <para>
	This section defines some configuration directives for the baseldap authenticator.
      </para>

      <table>
	<title>
	  Available options for the "authentication_externalldap" section
	</title>
	<tgroup cols="4">
	  <thead>
	    <row>
	      <entry>Option name</entry>
	      <entry>Description</entry>
	      <entry>Optional</entry>
	      <entry>Default value</entry>
	    </row>	  
	  </thead>
	  <tbody>
	    <row>
	      <entry>exclude</entry>
	      <entry>space-separated list of login that won't be authenticated using this authenticator.</entry>
	      <entry>yes</entry>
	      <entry></entry>
	    </row>
	    <row>
	      <entry>ldapurl</entry>
	      <entry>LDAP URL of the LDAP directory to connect to to authenticate user. You can specify multiple LDAP URLs, separated by spaces. Each LDAP server is tried until one successfully accepts a connection.</entry>
	      <entry>no</entry>
	      <entry></entry>
	    </row>
	    <row>
	      <entry>suffix</entry>
	      <entry>DN of the LDAP directory where to search users</entry>
	      <entry>no</entry>
	      <entry></entry>
	    </row>
	    <row>
	      <entry>bindname</entry>
	      <entry>DN of the LDAP directory account that must be used to bind to the LDAP directory and to perform the user search. If empty, an anonymous bind is done.</entry>
	      <entry>no</entry>
	      <entry></entry>
	    </row>
	    <row>
	      <entry>bindpasswd</entry>
	      <entry>Password of the LDAP directory account given by the bindname option. Not needed if bindname is empty.</entry>
	      <entry>no</entry>
	      <entry></entry>
	    </row>
	    <row>
	      <entry>filter</entry>
	      <entry>LDAP filter to use to search the user in the LDAP directory</entry>
	      <entry>yes</entry>
	      <entry>objectClass=*</entry>
	    </row>
	    <row>
	      <entry>attr</entry>
	      <entry>Name of the LDAP attribute that will allow to match a user entry with a LDAP search</entry>
	      <entry>no</entry>
	      <entry></entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para>
	For example, to authenticate a user using an Active Directory:
      </para>

      <screen>
	[authentication_externalldap]
	exclude = root
	ldapurl = ldap://192.168.0.1:389
	suffix = cn=Users,dc=adroot,dc=com
	bindname = cn=Administrator, cn=Users, dc=adroot, dc=com
	bindpasswd = s3cr3t
	filter = objectClass=*
	attr = cn
      </screen>

    </section>

  </section>

  <section>

    <title>User provisioning</title>

    <para>
      This feature allows to automatically create a user account if it does not already exist in the LDAP directory configured in the [ldap] section of the base plugin.
    </para>
    <para>
      User provisioning is needed for example if an external LDAP is used to authenticate users. The users won't be able to log in to the MMC web interface even if their login and password are rights, because the local LDAP doesn't store thir accounts.
    </para>

    <section>

      <title>Section « provisioning »</title>

      <para>
	This optional section tells the MMC agent provisioning manager how to provision a user account. Each Python plugin can register "provisioner" objects to the provisioning manager, that then can be used to provision users.
      </para>
      <para>
	When a user logs in to the MMC web interface, the authenticator manager authenticates this user. If the authentication succeed, then the provisioning manager runs each provisioner.
      </para>
      <para>
	The authenticator object that successfully authenticates the user must pass to the provisioning manager the user informations, so that the provisioners have data to create or update the user entry.
      </para>
      
      <table>
	<title>
	  Available options for the "provisioning" section
	</title>
	<tgroup cols="4">
	  <thead>
	    <row>
	      <entry>Option name</entry>
	      <entry>Description</entry>
	      <entry>Optional</entry>
	      <entry>Default value</entry>
	    </row>	  
	  </thead>
	  <tbody>
	    <row>
	      <entry>method</entry>
	      <entry>space-separated list of provisioners</entry>
	    <entry>yes</entry>
	    <entry></entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para>
	For example, this configuration tells to use the "externalldap" provisioner to create the user account:
      </para>
      <screen>
	[provisioning]
	method = externalldap
      </screen>

    </section>

    <section>

      <title>provisioning_external</title>

      <para>
	This section defines some configuration directives for the externalldap authenticator.
      </para>

      <table>
	<title>
	  Available options for the "authentication_externalldap" section
	</title>
	<tgroup cols="4">
	  <thead>
	    <row>
	      <entry>Option name</entry>
	      <entry>Description</entry>
	      <entry>Optional</entry>
	      <entry>Default value</entry>
	    </row>	  
	  </thead>
	  <tbody>
	    <row>
	      <entry>exclude</entry>
	      <entry>space-separated list of login that won't be provisioned by this provisioner.</entry>
	    <entry>yes</entry>
	    <entry></entry>
	    </row>
	    <row>
	      <entry>ldap_uid</entry>
	      <entry>name of the external LDAP field that is corresponding to the local uid field. The uid LDAP attribute is the user login.</entry>
	    <entry>no</entry>
	    <entry></entry>
	    </row>
	    <row>
	      <entry>ldap_givenName</entry>
	      <entry>name of the external LDAP field that is corresponding to the local givenName field</entry>
	    <entry>no</entry>
	    <entry></entry>
	    </row>
	    <row>
	      <entry>ldap_sn</entry>
	      <entry>name of the external LDAP field that is corresponding to the local sn (SurName) field</entry>
	    <entry>no</entry>
	    <entry></entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para>
	To create a user account, the MMC agent needs its login, its password, its given name and its surname. That's why the ldap_uid, ldap_givenName and ldap_sn options are mandatory.
      </para>

      <para>
	Here is a simple example of an authenticators and provisioners chain that authenticates users using an Active Directory, and create accounts:
      </para>

      <screen>
	[authentication]
	method = baseldap externalldap

	[authentication_externalldap]
	exclude = root
	ldapurl = ldap://192.168.0.1:389
	suffix = cn=Users,dc=adroot,dc=com
	bindname = cn=Administrator, cn=Users, dc=adroot, dc=com
	bindpasswd = s3cr3t
	filter = objectClass=*
	attr = cn

	[provisioning]
	method = externalldap
	
	[provisioning_externalldap]
	exclude = root
	ldap_uid = cn
	ldap_givenName = sn
	ldap_sn = sn
      </screen>

    </section>

  </section>


</article>
